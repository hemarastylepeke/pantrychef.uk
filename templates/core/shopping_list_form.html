{% extends 'core/base.html' %}

{% block title %}{{ title }} - Pantry Pilot{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 py-8">
    <div class="container mx-auto px-4 max-w-4xl">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-green-500 to-blue-500 px-8 py-6">
                <h1 class="text-2xl md:text-3xl font-bold text-white">{{ title }}</h1>
                <p class="text-green-100 mt-2">Create and manage your shopping list</p>
            </div>

            <!-- Form -->
            <div class="p-8">
                <form method="post" class="space-y-8">
                    {% csrf_token %}
                    
                    <!-- Shopping List Information -->
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">List Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Name -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">List Name *</label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.name.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Budget Limit -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Budget Limit ($)</label>
                                {{ form.budget_limit }}
                                {% if form.budget_limit.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.budget_limit.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                            <!-- Week Number -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Week Number</label>
                                {{ form.week_number }}
                                {% if form.week_number.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.week_number.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Month -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                                {{ form.month }}
                                {% if form.month.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.month.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Year -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Year</label>
                                {{ form.year }}
                                {% if form.year.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.year.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.status.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Shopping List Items -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Shopping List Items</h3>
                            <button type="button" id="add-item-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                Add Another Item
                            </button>
                        </div>
                        
                        {{ formset.management_form }}
                        <div id="items-formset" class="space-y-6">
                            {% for form in formset %}
                            <div class="item-form bg-gray-50 rounded-lg p-6 border border-gray-200">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-medium text-gray-800">Item {{ forloop.counter }}</h4>
                                    {% if form.instance.pk %}
                                        {{ form.DELETE }}
                                    {% endif %}
                                    <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 text-sm font-medium">
                                        Remove
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Ingredient -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Ingredient *</label>
                                        {{ form.ingredient }}
                                        {% if form.ingredient.errors %}
                                            <div class="text-red-500 text-sm mt-1">{{ form.ingredient.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Quantity -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                                        {{ form.quantity }}
                                        {% if form.quantity.errors %}
                                            <div class="text-red-500 text-sm mt-1">{{ form.quantity.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <!-- Unit -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                                        {{ form.unit }}
                                        {% if form.unit.errors %}
                                            <div class="text-red-500 text-sm mt-1">{{ form.unit.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Estimated Price -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Price ($)</label>
                                        {{ form.estimated_price }}
                                        {% if form.estimated_price.errors %}
                                            <div class="text-red-500 text-sm mt-1">{{ form.estimated_price.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                    <!-- Priority -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                                        {{ form.priority }}
                                        {% if form.priority.errors %}
                                            <div class="text-red-500 text-sm mt-1">{{ form.priority.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <!-- Reason -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason</label>
                                        {{ form.reason }}
                                        {% if form.reason.errors %}
                                            <div class="text-red-500 text-sm mt-1">{{ form.reason.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                        <div class="text-red-500 text-sm mt-1">{{ form.notes.errors }}</div>
                                    {% endif %}
                                </div>

                                <!-- Hidden fields -->
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
                        <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-semibold transition-colors duration-200 transform hover:scale-105">
                            {% if shopping_list %}Update Shopping List{% else %}Create Shopping List{% endif %}
                        </button>
                        <a href="{% if shopping_list %}{% url 'shopping_list_detail' shopping_list.id %}{% else %}{% url 'shopping_list_list' %}{% endif %}" 
                           class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold text-center transition-colors duration-200">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formset = document.getElementById('items-formset');
    const addButton = document.getElementById('add-item-btn');
    const totalForms = document.getElementById('id_items-TOTAL_FORMS');
    let formCount = parseInt(totalForms.value);

    addButton.addEventListener('click', function() {
        const newForm = formset.children[0].cloneNode(true);
        const formRegex = new RegExp(`items-(\\d){1}-`, 'g');
        
        // Update form index
        newForm.innerHTML = newForm.innerHTML.replace(formRegex, `items-${formCount}-`);
        
        // Clear input values
        const inputs = newForm.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.type !== 'hidden' && input.name !== 'csrfmiddlewaretoken') {
                input.value = '';
            }
        });
        
        // Update labels
        const labels = newForm.querySelectorAll('label');
        labels.forEach(label => {
            const forAttr = label.getAttribute('for');
            if (forAttr) {
                label.setAttribute('for', forAttr.replace(formRegex, `items-${formCount}-`));
            }
        });
        
        // Update heading
        const heading = newForm.querySelector('h4');
        if (heading) {
            heading.textContent = `Item ${formCount + 1}`;
        }
        
        formset.appendChild(newForm);
        formCount++;
        totalForms.value = formCount;
    });

    // Remove item functionality
    formset.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item-btn')) {
            if (formset.children.length > 1) {
                e.target.closest('.item-form').remove();
                formCount--;
                totalForms.value = formCount;
                
                // Reindex remaining forms
                const forms = formset.querySelectorAll('.item-form');
                forms.forEach((form, index) => {
                    const formRegex = new RegExp(`items-(\\d){1}-`, 'g');
                    form.innerHTML = form.innerHTML.replace(formRegex, `items-${index}-`);
                    
                    const heading = form.querySelector('h4');
                    if (heading) {
                        heading.textContent = `Item ${index + 1}`;
                    }
                    
                    // Update labels
                    const labels = form.querySelectorAll('label');
                    labels.forEach(label => {
                        const forAttr = label.getAttribute('for');
                        if (forAttr) {
                            label.setAttribute('for', forAttr.replace(formRegex, `items-${index}-`));
                        }
                    });
                });
            }
        }
    });
});
</script>
{% endblock %}